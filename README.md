# Golang Starter

## Table Of Contents

- [Golang Starter](#golang-starter)
  - [Table Of Contents](#table-of-contents)
  - [Introduction](#introduction)
  - [Architecture](#architecture)
  - [Aspects](#aspects)
  - [Setup instructions](#setup-instructions)
    - [Prerequisites](#prerequisites)
    - [**Step 1 : Clone the repo**](#step-1--clone-the-repo)
    - [**Step 2 : Initialize the Infrastructure using Docker Compose**](#step-2--initialize-the-infrastructure-using-docker-compose)
    - [**Step 3 : Configure the Infrastructure**](#step-3--configure-the-infrastructure)
      - [**Configure Hashicorp Vault**](#configure-hashicorp-vault)
      - [**Configure Hashicorp Consul**](#configure-hashicorp-consul)
      - [**Configure Postgres Database**](#configure-postgres-database)
    - [**Step 4: Run Payment Service**](#step-4-run-payment-service)
    - [**Step 5: Test payment API**](#step-5-test-payment-api)
    - [**Step 6: Clean Up**](#step-6-clean-up)
  - [Appendix](#appendix)

## Introduction

* Golang catalyst project has been build in with all established and recommended practices. It covers following aspects
  * Spread common pattern and practices followed in the community.
  * An opinionated code structure along with recommended coding practices.
  * A set of recommended libraries.
  * Provide default extendable implementation with tools such as code coverage, documentation, metrics, logging and
    security.
  * A decent local dev set up.

## Architecture

- For architecture design designs and considerations, please refer [architecture documentation](docs/architecture.md)
- Documentation for each aspect can be found at [Appendix](#appendix) section
## Aspects

**Golang catalyst project has covered following high level aspects of a microservices**

- [x] Developer Machine setup
- [x] Clean Architecture, DDD and CQRS based implementation
- [x] Metrics visualization
- [x] Application Secret Management
- [x] Centralized configuration
- [x] Log aggregation and visualization
- [x] Centralized Error Handling
- [x] Structured logging
- [x] Metrics collection
- [x] Distributed Tracing
- [x] Efficient Validations
- [x] Unit tests
- [x] Component Tests
- [x] Dependencies vulnerability checks
- [x] CI pipeline

## Setup instructions

### Prerequisites

- [GO 1.8](https://go.dev/dl/)
- **Docker and Docker Compose** (Note: tested on [Colima](docs/colima.md))
- Note: for ELK stack, 6GB of ram must be allocated for docker daemon.


### **Step 1 : Clone the repo**
```bash
$ git clone git@github.com:Regional-IT-India/catalyst-service-golang-starter-clean-architecture.git
$ cd catalyst-service-golang-starter-clean-architecture
```


### **Step 2 : Initialize the Infrastructure using Docker Compose**

* Default environment values are present at [docker.yaml](localDevSetup/docker.yaml) file (Modify them as per the requirement).
* If docker desktop is not installed, then you may use [**colima**](./docs/colima.md).
* Setup heavily depends on the [Makefile](Makefile) targets.
* To bring up all the infra components run below command
```bash
$ make demo-infra
```
* Once above command is successful, we can access tools at below addresses
    * Consul: http://localhost:8500
    * Vault : http://localhost:8200/ui/vault/secrets
    * Prometheus : http://localhost:9090/
    * Grafana: http://localhost:3000/ - Credential (admin, admin)
    * Jaeger : http://localhost:16686/search
    * Kibana : http://localhost:5601/
* Please refer [Containerization Approach](docs/containerization.md) for details on custom configurations and best
  practices.



### **Step 3 : Configure the Infrastructure**

#### **Configure Hashicorp Vault**
```bash
$ make vault-setup
$ export VAULT_ADDRESS=http://vault:8200
```   
- After running the above command, you will find `UNSEAL_KEY`, `ROOT_TOKEN`, `ROLE_ID`, `SECRET_ID` in the console output. Please take a note of these values.
* `UNSEAL_KEY` and `ROOT_TOKEN` will be required to access Vault from UI and to unseal Vault.
* `ROLE_ID` and `SECRET_ID` will be required to access secrets stored in Vault from application.

- Run the following command to push the secrets to vault.
```bash
$ export VAULT_TOKEN=<your-vault-root-token> # generated by `make vault-setup`
$ make vault-store-secrets   
```
- This will export DB_PASSWORD to vault, refer `localDevSetup/vault/setup.sh`.
- Please refer `Secret Management` section in [Configuration documentation](docs/configuration.md) for more information on vault configuration, best practices and how to access vault UI.

#### **Configure Hashicorp Consul**
```bash
$ make consul-store-config
```
- This will store all centralized configuration in consul using curl commands.
- [AppConfig.json](localDevSetup/consul/config/appConfig.json) contains all the configs to be stored in consul
- Please refer `Central Config` section in [Configuration documentation](docs/configuration.md) for more information on vault configuration, best practices and how to access vault UI.

#### **Configure Postgres Database**
```bash
$ make init-db
$ make run-migrations
```
- First command creates a new database and user for the use of payment service.
- Second command runs migration. `.sql` files are present in [scripts](persistence/migrations/scripts/)
- We are using [golang-migrate](docs/db-migrations.md) for running migrations. A separate binary will be created for running migrations, refer [migrations](cmd/migrations/main.go)

### **Step 4: Run Payment Service**

* Ensure [vault](docs/configuration.md) is unseal,  and environment variables `ROLE_ID` and `SECRET_ID` are exported. Please refer [Configure infrastructure](#step-3--configure-the-infrastructure)
```shell
$ make demo-app
```

### **Step 5: Test payment API**
Please refer [testing docs](docs/test-payment-api.md) for API routes and payloads. Also contains steps to run unit and component tests. 

### **Step 6: Clean Up**

To clean up resources
```shell
$ make CMD="down" demo-infra
$ make CMD="down" demo-app
```

## Appendix
**More information about each aspect can be found below documents.**
- Architecture, design principles and sample microservice architecture: [Architecture](docs/architecture.md)
- Containerization approaches and best practices: [Containerization](docs/containerization.md)
- Telemetry data: Metrics/Monitoring, Distributed Tracing, Logging: [Telemetry](docs/telemetry.md)
- Configuration: Central Config, Secret Management, File Configs: [Configuration](docs/configuration.md)
- Database Migrations technique: [DB Migrations](docs/db-migrations.md)
- Error handling in golang starter kit: [Error handling](docs/error-handling.md)
- Continuous integration, CI workflow: [Continuous Integration](docs/continous-integration.md)
- To test payment API, check this [Testing](docs/test-payment-api.md)
- Docker troubleshooting and Colima guide: [Colima](docs/colima.md)
- Tooling which we use and recommend: [Tools](docs/tools.md)
